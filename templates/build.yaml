parameters:
  name: ""

stages:
  - stage: build_${{ parameters.name }}
    pool:
      vmImage: 'windows-latest'
    displayName: Build chocolatey package ${{ parameters.name }}
    jobs:
    - job: build-${{ parameters.name }}-job
      displayName: Build, Pack and Test ${{ parameters.name }}
      steps:
        - task: UseGitVersion@5
          displayName: gitversion
          inputs:
            versionSpec: '5.x'
            updateAssemblyInfo: true
        - task: gitversion/setup@0
        displayName: Install GitVersion
        inputs:
          versionSpec: '5.5.0'
      - script: |
          echo Building ${{ parameters.name }}
          cd ${{ parameters.name }}
          choco pack
          cp *.nupkg $(Build.ArtifactStagingDirectory)/
          echo $(Build.ArtifactStagingDirectory)
          ls $(Build.ArtifactStagingDirectory)
        displayName: Run choco pack to build ${{ parameters.name }}

      - task: Cache@2
        inputs:
          key: 'chocolatey | "$(Agent.OS)" | "${{ parameters.name }}" '
          restoreKeys: |
            chocolatey | "$(Agent.OS)"
          path: $(CHOCOLATEY_CACHE_DIR)
        displayName: Chocolatey cache
      - script: choco source add -n=local -s "$(Build.ArtifactStagingDirectory)"
        displayName: Add chocolatey repo
      - script: choco config set cacheLocation "$(CHOCOLATEY_CACHE_DIR)"
        displayName: Set chocolatey cache dir
      - script: choco install --pre ${{ parameters.name }}
        displayName: Install new chocolatey package ${{ parameters.name }}

      - task: NuGetAuthenticate@0
        displayName: 'NuGet Authenticate'
      - task: NuGetCommand@2
        displayName: 'NuGet push'
        inputs:
          command: push
          publishVstsFeed: 'choco-vc/choco-vc'
          allowPackageConflicts: true

